{% extends "base.html" %}
{% block content %}

<style>
  .ios-screen {
    max-width: 430px;
    margin: 0 auto;
    background: #fff;
    min-height: 100vh;
  }

  .ios-topbar {
    position: sticky;
    top: 0;
    background: #fff;
    border-bottom: 1px solid #e9e9e9;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .ios-back {
    position: absolute;
    left: 12px;
    text-decoration: none;
    font-size: 26px;
    line-height: 1;
    color: #111;
  }

  .ios-title {
    font-weight: 800;
    font-size: 18px;
  }

  .pro-row {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 14px;
    border-bottom: 1px solid #eee;
  }

  .pro-photo {
    width: 56px;
    height: 56px;
    border-radius: 10px;
    object-fit: cover;
    border: 1px solid #e6e6e6;
  }

  .pro-name {
    font-weight: 800;
  }

  .pro-sub {
    color: #6c757d;
    font-size: 14px;
  }

  .pill {
    border-radius: 10px;
  }

  .text-truncate-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    white-space: normal;
  }
</style>

<!-- BUSCADOR -->
<div class="px-3 mb-2">
  <form action="/ui/results" method="GET" class="position-relative">
    <input type="hidden" name="cat" value="{{ cat }}">
    <input type="hidden" name="view_mode" value="{{ view_mode }}">
    <input type="text" name="q" value="{{ q }}" placeholder="Buscar..."
      class="form-control pill py-2 ps-5 border-0 shadow-sm" style="background: #f1f5f9;">
    <span class="position-absolute top-50 start-0 translate-middle-y ms-3 text-muted">üîé</span>
    <button type="submit"
      class="btn btn-dark pill btn-sm position-absolute top-50 end-0 translate-middle-y me-1 py-1 px-3"
      style="font-size: 0.8rem; margin-right: 4px;">Buscar</button>
  </form>
</div>

<!-- FILTROS PREMIUM INMOBILIARIA -->
{% if "Inmobiliaria" in cat %}
<div class="px-3 mb-3">
  <form action="/ui/results" method="GET" class="d-flex flex-column gap-2 p-3 bg-white border border-light shadow-sm"
    style="border-radius: 16px;">
    <input type="hidden" name="cat" value="{{ cat }}">
    <input type="hidden" name="view_mode" value="{{ view_mode }}">
    <input type="hidden" name="q" value="{{ q }}">

    <div class="d-flex gap-2">
      <select name="op" class="form-select border-0 bg-light pill-sm flex-grow-1" style="font-size: 0.9rem;">
        <option value="">Operaci√≥n...</option>
        <option value="Venta" {% if op=='Venta' %}selected{% endif %}>Venta</option>
        <option value="Alquiler" {% if op=='Alquiler' %}selected{% endif %}>Alquiler</option>
      </select>
      <select name="rooms" class="form-select border-0 bg-light pill-sm" style="font-size: 0.9rem; width: 35%;">
        <option value="">Hab...</option>
        <option value="1" {% if rooms=='1' %}selected{% endif %}>1+</option>
        <option value="2" {% if rooms=='2' %}selected{% endif %}>2+</option>
        <option value="3" {% if rooms=='3' %}selected{% endif %}>3+</option>
        <option value="4" {% if rooms=='4' %}selected{% endif %}>4+</option>
      </select>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <div class="position-relative flex-grow-1">
        <input type="number" name="sqm" value="{{ sqm }}" placeholder="M√≠n. m¬≤"
          class="form-control border-0 bg-light pill-sm" style="font-size: 0.9rem; padding-left: 12px;">
      </div>
      <button type="submit" class="btn btn-primary pill-sm py-2 px-4 shadow-sm"
        style="background: #002c5f; border: none; font-weight: 600;">Filtrar</button>
    </div>
  </form>
</div>
{% endif %}

<!-- Bot√≥n publicar din√°mico (solo para ventas/inmo/motor) -->
{% if cat and ("Mercado" in cat or "Inmobiliaria" in cat or "Veh√≠culos" in cat) %}
<div class="px-2 mb-3">
  <a href="/ui/offers/new?type=sales&fixed_cat={{ cat }}" class="btn btn-dark w-100 pill py-3 fw-bold shadow-sm">
    {% if "Inmobiliaria" in cat %}
    üè° Publicar Inmueble
    {% elif "Veh√≠culos" in cat %}
    üèéÔ∏è Publicar Veh√≠culo
    {% else %}
    üè™ Publicar Producto
    {% endif %}
  </a>
</div>
{% endif %}

{% if view_mode == 'mosaic' %}
<!-- MOSAICO PARA PRODUCTOS -->
<div class="row g-2">
  {% for p in results %}
  <div class="col-6">
    <a href="/ui/feed?cat={{cat}}&q={{q}}&start_id={{p.id}}" class="text-decoration-none text-dark">
      <div class="card h-100 border-0 shadow-sm" style="border-radius:12px; overflow:hidden;">
        <!-- Video/Foto Preview -->
        <div class="bg-dark d-flex align-items-center justify-content-center" style="height:140px; position:relative;">
          {% if p.video %}
          <video src="{{ p.video }}" class="w-100 h-100" style="object-fit:cover;" muted loop onmouseover="this.play()"
            onmouseout="this.pause()"></video>
          {% elif p.photo %}
          <img src="{{ p.photo }}" class="w-100 h-100" style="object-fit:cover;">
          {% else %}
          <!-- Placeholder sin foto -->
          <span style="color:white; font-size:10px;">Sin v√≠deo/foto</span>
          {% endif %}

          <div class="badge bg-success text-white position-absolute top-0 start-0 m-2 shadow-sm"
            style="font-size:12px; font-weight:800;">
            {{ p.price | format_price }} ‚Ç¨
          </div>
        </div>
        <div class="p-2">
          <div class="fw-bold text-truncate" style="font-size:14px;">{{ p.title }}</div>
          <div class="d-flex justify-content-between align-items-center mt-1">
            <span class="fw-bold" style="color: #002c5f;">{{ p.price | format_price }} ‚Ç¨</span>
            <span class="small text-muted">{{ p.distance_km }} km</span>
          </div>
          {% if p.extra and (p.extra.rooms or p.extra.sqm) %}
          <div class="mt-2 d-flex gap-1 flex-wrap">
            {% if p.extra.rooms %}<span class="badge bg-light text-dark border-0" style="font-size: 0.7rem;">{{
              p.extra.rooms }} hab.</span>{% endif %}
            {% if p.extra.sqm %}<span class="badge bg-light text-dark border-0" style="font-size: 0.7rem;">{{
              p.extra.sqm }} m¬≤</span>{% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </a>
  </div>
  {% else %}
  <div class="col-12 text-center py-5 muted">
    No hay productos en esta categor√≠a.
  </div>
  {% endfor %}
</div>

{% else %}
<!-- LISTA PARA SERVICIOS (Original) -->
<div class="d-flex flex-column gap-3">
  {% for p in results %}
  <a href="/ui/profile/{{ p.id }}" class="text-decoration-none text-dark">
    <div class="card-soft p-3 d-flex align-items-center gap-3">
      <img src="{{ p.photo }}" class="rounded-circle bg-secondary" style="width:56px; height:56px; object-fit:cover;">
      <div class="flex-grow-1" style="min-width:0;">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-0 fw-bold text-truncate">{{ p.role }}</h6>
            <div class="text-secondary small text-truncate-2 mt-1">{{ p.desc }}</div>
            {% if p.extra and (p.extra.rooms or p.extra.sqm) %}
            <div class="mt-2 d-flex gap-1 flex-wrap">
              {% if p.extra.rooms %}<span class="badge bg-light text-dark border-0" style="font-size: 0.7rem;">{{
                p.extra.rooms }} hab.</span>{% endif %}
              {% if p.extra.sqm %}<span class="badge bg-light text-dark border-0" style="font-size: 0.7rem;">{{
                p.extra.sqm }} m¬≤</span>{% endif %}
              {% if p.extra.operation_type %}<span class="badge bg-success bg-opacity-10 text-success border-0"
                style="font-size: 0.7rem;">{{ p.extra.operation_type }}</span>{% endif %}
            </div>
            {% endif %}
          </div>
          <div class="d-flex flex-column align-items-end flex-shrink-0 ms-2">
            <span class="badge bg-light text-dark border mb-1">{{ p.distance_km }} km</span>
            {% if p.price is not none %}
            <span class="badge bg-success bg-opacity-10 text-success border border-success">{{ p.price | format_price }}
              ‚Ç¨</span>
            {% endif %}
          </div>
        </div>
        <div class="d-flex align-items-center gap-2 small muted mt-2">
          <span>{{ p.offer_cat }}</span>
          <span>‚Ä¢</span>
          <span>{{ p.status }}</span>
        </div>
      </div>
    </div>
</div>
</a>
{% else %}
<div class="text-center py-5 muted">
  No se encontraron profesionales.
</div>
{% endfor %}
</div>
{% endif %}
</div>

{% endblock %}