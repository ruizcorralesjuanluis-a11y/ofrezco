{% extends "base.html" %}
{% block content %}

<style>
  .ios-screen {
    max-width: 430px;
    margin: 0 auto;
    background: #fff;
    min-height: 100vh;
  }

  .ios-topbar {
    position: sticky;
    top: 0;
    background: #fff;
    border-bottom: 1px solid #e9e9e9;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .ios-back {
    position: absolute;
    left: 12px;
    text-decoration: none;
    font-size: 26px;
    line-height: 1;
    color: #111;
  }

  .ios-title {
    font-weight: 800;
    font-size: 18px;
  }

  .pro-row {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 14px;
    border-bottom: 1px solid #eee;
  }

  .pro-photo {
    width: 56px;
    height: 56px;
    border-radius: 10px;
    object-fit: cover;
    border: 1px solid #e6e6e6;
  }

  .pro-name {
    font-weight: 800;
  }

  .pro-sub {
    color: #6c757d;
    font-size: 14px;
  }

  .pill {
    border-radius: 10px;
  }
</style>

<!-- RESULTADOS -->
<div class="mt-3">
  <!-- Buscador Integrado -->
  <div class="px-2 mb-3">
    <form action="/ui/results" method="get" class="position-relative">
      <input type="hidden" name="cat" value="{{ cat }}">
      <input type="hidden" name="mode" value="{{ mode }}">
      <div class="input-group bg-light rounded-pill px-3 py-1 border shadow-sm">
        <span class="input-group-text bg-transparent border-0 text-muted px-0">üîç</span>
        <input type="text" name="q" class="form-control bg-transparent border-0 shadow-none"
          placeholder="Buscar en {{ 'Mercadillo' if mode == 'sales' else 'Servicios' }}..." value="{{ q }}">
        {% if q %}
        <a href="/ui/results?cat={{ cat }}&mode={{ mode }}"
          class="btn btn-link text-decoration-none text-muted p-0 d-flex align-items-center">‚úï</a>
        {% endif %}
      </div>
    </form>
  </div>
  {% if view_mode == 'mosaic' %}
  <!-- MOSAICO PARA PRODUCTOS -->
  <div class="row g-2">
    {% for p in results %}
    <div class="col-6">
      <a href="/ui/offers/{{ p.offer_id }}" class="text-decoration-none text-dark">
        <div class="card h-100 border-0 shadow-sm" style="border-radius:12px; overflow:hidden;">
          <!-- Video/Foto Preview -->
          <div class="bg-dark d-flex align-items-center justify-content-center"
            style="height:140px; position:relative;">
            {% if p.photo %}
            <img src="{{ p.photo }}" class="w-100 h-100" style="object-fit:cover;">
            {% elif p.video %}
            <video src="{{ p.video }}" class="w-100 h-100" style="object-fit:cover;" muted loop
              onmouseover="this.play()" onmouseout="this.pause()"></video>
            {% else %}
            <!-- Placeholder sin foto -->
            <span style="color:white; font-size:10px;">Sin imagen</span>
            {% endif %}

            <div class="badge bg-success text-white position-absolute top-0 start-0 m-2 shadow-sm"
              style="font-size:12px; font-weight:800;">
              {{ p.price }} ‚Ç¨
            </div>
          </div>
          <div class="p-2">
            <div class="fw-bold text-truncate" style="font-size:14px;">{{ p.title }}</div>
            <div class="text-muted small text-truncate">{{ p.category }}</div>
            {% if p.rating_count > 0 %}
            <div class="d-flex align-items-center gap-1 mt-1">
              <span class="text-warning fw-bold" style="font-size:13px;">‚òÖ {{ p.rating_avg }}</span>
              <span class="text-muted" style="font-size:11px;">({{ p.rating_count }})</span>
            </div>
            {% else %}
            <div class="text-muted mt-1" style="font-size:11px;">Sin valoraciones</div>
            {% endif %}
          </div>
        </div>
      </a>
    </div>
    {% else %}
    <div class="col-12 text-center py-5 muted">
      No hay productos en esta categor√≠a.
    </div>
    {% endfor %}
  </div>

  {% else %}
  <!-- LISTA PARA SERVICIOS (Original) -->
  <div class="d-flex flex-column gap-3">
    {% for p in results %}
    <a href="/ui/offers/{{ p.offer_id }}" class="text-decoration-none text-dark">
      <div class="card-soft p-3 d-flex align-items-center gap-3">
        {% if p.photo %}
        <img src="{{ p.photo }}" class="rounded-circle"
          style="width:56px; height:56px; object-fit:cover; flex-shrink:0; border:1px solid #eee;">
        {% elif p.video %}
        <div
          style="width:56px; height:56px; border-radius:50%; overflow:hidden; background:#000; border:1px solid #eee; flex-shrink:0;">
          <video src="{{ p.video }}" class="w-100 h-100" style="object-fit:cover;" muted loop onmouseover="this.play()"
            onmouseout="this.pause()"></video>
        </div>
        {% else %}
        <img src="https://via.placeholder.com/56" class="rounded-circle bg-secondary"
          style="width:56px; height:56px; object-fit:cover; flex-shrink:0;">
        {% endif %}
        <div class="flex-grow-1" style="min-width:0;">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold text-truncate">{{ p.name }}</h6>
            <div class="d-flex flex-column align-items-end">
              <span class="badge bg-light text-dark border mb-1">{{ p.distance_km }} km</span>
              {% if p.price is not none %}
              <span class="badge bg-success bg-opacity-10 text-success border border-success">{{ p.price }} ‚Ç¨</span>
              {% endif %}
            </div>
          </div>
          <div class="text-primary small mb-1">{{ p.role }}</div>
          <div class="d-flex align-items-center gap-2 small muted">
            <span>{{ p.offer_cat }}</span>
            <span>‚Ä¢</span>
            <span>{{ p.status }}</span>
            {% if p.rating_count > 0 %}
            <span>‚Ä¢</span>
            <span class="text-warning fw-bold">‚òÖ {{ p.rating_avg }} ({{ p.rating_count }})</span>
            {% endif %}
          </div>
        </div>
      </div>
    </a>
    {% else %}
    <div class="text-center py-5 muted">
      No se encontraron profesionales.
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

{% endblock %}