{% extends "base.html" %}

{% block content %}
<div class="ios-screen p-4" style="max-width: 500px; margin: 20px auto;">
  <div class="mb-4 text-center">
    <h1 style="font-weight: 800; font-size: 24px;">Crear Perfil</h1>
    <p class="text-muted">Cuéntanos un poco sobre ti para empezar.</p>
  </div>

  <form id="profileForm">
    <div class="form-group">
      <label class="form-label">Tipo de perfil</label>
      <select id="profileType" class="form-control-custom form-select-custom">
        <option value="PRO">Profesional (Ofrezco servicios)</option>
        <option value="COMUNITARIO">Comunitario (Solo busco ayuda)</option>
        <option value="AMBOS">Ambos</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Descripción breve</label>
      <textarea id="profileDesc" class="form-control-custom" rows="3"
        placeholder="Ej. Electricista con 10 años de experiencia..."></textarea>
    </div>

    <!-- Hidden Video/Photo fields for now, simplified flow -->

    <button type="button" class="btn-primary-block mt-4" onclick="submitProfile()">Crear mi perfil</button>
  </form>

</div>

<script>
  async function submitProfile() {
    const type = document.getElementById("profileType").value;
    const desc = document.getElementById("profileDesc").value;
    const userId = {{ user_id }
  }; // Injected from backend

  if (!userId) {
    alert("Error de sesión. Por favor inicia sesión de nuevo.");
    window.location.href = "/ui/login";
    return;
  }

  const res = await fetch("/api/v1/profiles", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      user_id: userId,
      profile_type: type,
      description: desc,
      available_now: true
    })
  });

  if (res.ok) {
    // Guardar en localstorage para la UI legacy que lo use explícitamente y redireccionar
    const data = await res.json();
    localStorage.setItem("me_profile_id", data.id);
    window.location.href = "/ui";
  } else {
    alert("Error al crear perfil. Inténtalo de nuevo.");
  }
}
</script>
{% endblock %}