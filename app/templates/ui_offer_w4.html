{% extends "base.html" %}
{% block content %}
<div class="ios-screen">
  <div class="ios-section d-flex align-items-center gap-2">
    <a class="btn btn-link p-0" href="/ui/offers/new/3" style="text-decoration:none;font-size:20px;">‚Üê</a>
    <div class="fw-black" style="font-weight:900;font-size:22px;letter-spacing:-.4px;">Verificaci√≥n</div>
    <div class="ms-auto muted" style="font-size:13px;">4/4</div>
  </div>
</div>

<!-- Formulario estilo iOS -->
<div class="card-soft overflow-hidden p-0 mt-3">
  <div class="px-3 py-2 bg-light border-bottom small fw-bold text-uppercase muted"
    style="letter-spacing:1px; font-size:11px;">
    PASO 4 ¬∑ V√çDEO Y REVISI√ìN
  </div>

  <div class="p-4 text-center border-bottom bg-white">
    <p class="muted small mb-3">Graba un v√≠deo corto (max 30s) present√°ndote. Aumenta mucho tus posibilidades.</p>

    <label class="btn btn-outline-primary pill d-inline-flex align-items-center gap-2">
      üìπ Grabar / Subir V√≠deo
      <input id="wVideo" type="file" accept="video/*" capture="environment" style="display:none"
        onchange="document.getElementById('videoLabel').textContent = this.files[0]?.name || 'V√≠deo seleccionado';" />
    </label>
    <div id="videoLabel" class="small mt-2 text-primary fw-bold"></div>
  </div>

  <div class="p-3 bg-light">
    <div class="small fw-bold text-uppercase muted mb-2">RESUMEN DE LA OFERTA</div>
    <div id="summary" class="small text-dark" style="line-height:1.6;"></div>
  </div>

  <div class="p-3 border-top bg-white">
    <button class="btn btn-link text-danger w-100 text-decoration-none small" onclick="clearDraft()">üóë Eliminar
      borrador y empezar de cero</button>
  </div>
</div>

<div class="d-flex gap-2 mt-3">
  <a class="btn btn-light flex-grow-1 pill" href="/ui/offers/new/3">Atr√°s</a>
  <button class="btn btn-success flex-grow-1 pill" onclick="publish()">Publicar oferta</button>
</div>

<script>
  function wDraftKey() {
    const pid = localStorage.getItem("me_profile_id") || "";
    return "draft_offer_" + (pid || "anon");
  }
  function loadDraft() { try { return JSON.parse(localStorage.getItem(wDraftKey()) || "{}"); } catch (e) { return {}; } }
  function saveDraft(patch) {
    const d = loadDraft();
    const n = Object.assign({}, d, patch);
    localStorage.setItem(wDraftKey(), JSON.stringify(n));
    return n;
  }
  function clearDraft() {
    localStorage.removeItem(wDraftKey());
    renderSummary();
    alert("Borrador eliminado.");
  }
  function renderSummary() {
    const d = loadDraft();
    const s = document.getElementById("summary");
    const lines = [];
    if (d.category) lines.push(`<b>Categor√≠a:</b> ${d.category}`);
    if (d.title) lines.push(`<b>T√≠tulo:</b> ${d.title}`);
    if (d.specialty) lines.push(`<b>Especialidad:</b> ${d.specialty}`);
    if (d.zone_text) lines.push(`<b>Zona:</b> ${d.zone_text}`);
    if (d.service_radius_km) lines.push(`<b>Radio:</b> ${d.service_radius_km} km`);
    lines.push(`<b>Disponible ahora:</b> ${d.available_now ? "S√≠" : "No"}`);
    if (d.price != null) lines.push(`<b>Precio:</b> ${d.price} ‚Ç¨`);
    s.innerHTML = lines.join("<br>");
  }
  async function publish() {
    const profileId = localStorage.getItem("me_profile_id");
    if (!profileId) { alert("Selecciona o crea un Perfil en ‚ÄúCuenta‚Äù primero."); return; }

    const d = loadDraft();
    // 1) Crear oferta O producto
    let isProduct = false;
    if (d.category_group && (d.category_group.includes("Mercadillo") || d.category_group.includes("Venta"))) {
      isProduct = true;
    }

    let payload, endpoint;

    if (isProduct) {
      endpoint = "/api/v1/products";
      payload = {
        profile_id: Number(profileId),
        category: d.category,
        title: d.title,
        description: (d.description || "").trim() || null,
        price: (d.price == null ? null : Number(d.price)),
        currency: "EUR"
      };
    } else {
      endpoint = "/api/v1/offers";
      payload = {
        profile_id: Number(profileId),
        offer_kind: "SERVICE",
        category: d.category,
        title: d.title,
        description: (d.description || "").trim() || null,
        price: (d.price == null ? null : Number(d.price)),
        currency: "EUR",
        available_now: !!d.available_now,
        allergens: d.specialty ? String(d.specialty) : null
      };
    }

    let item;
    try {
      const r = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j.detail || ("HTTP " + r.status));
      item = j;
    } catch (e) {
      alert("Error creando: " + e.message);
      return;
    }

    // 2) Subir v√≠deo (OBLIGATORIO para ambos ahora)
    const f = document.getElementById("wVideo").files[0];
    if (f) {
      try {
        const fd = new FormData();
        fd.append("file", f);
        // Endpoint video din√°mico
        const vidEndpoint = isProduct ? `/api/v1/products/${item.id}/video` : `/api/v1/offers/${item.id}/video`;

        const r2 = await fetch(vidEndpoint, { method: "POST", body: fd });
        const j2 = await r2.json();
        if (!r2.ok) throw new Error(j2.detail || ("HTTP " + r2.status));
        item = j2;
      } catch (e) {
        alert("Creado, pero el v√≠deo fall√≥: " + e.message);
        return;
      }
    } else {
      // Fallar√° en el submit si no hay video
    }

    // 3) Enviar a revisi√≥n / Publicar
    try {
      const subEndpoint = isProduct ? `/api/v1/products/${item.id}/submit` : `/api/v1/offers/${item.id}/submit`;
      const r3 = await fetch(subEndpoint, { method: "POST" });
      const j3 = await r3.json();
      if (!r3.ok) throw new Error(j3.detail || ("HTTP " + r3.status));

      localStorage.removeItem(wDraftKey());
      alert("¬°Publicado con √©xito!");
      location.href = "/ui/offers";
    } catch (e) {
      alert("Creado, pero error al publicar: " + e.message);
    }
  }

  (function init() {
    // label perfil activo 
    const pid = localStorage.getItem("me_profile_id");
    const el = document.getElementById("activeProfileLabel");
    if (pid) el.textContent = "#" + pid;
    renderSummary();
  })();
</script>
{% endblock %}