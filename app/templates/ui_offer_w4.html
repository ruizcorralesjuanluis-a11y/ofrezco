{% extends "base.html" %}
{% block content %}
<div class="ios-screen">
  <div class="ios-section d-flex align-items-center gap-2">
    <a class="btn btn-link p-0" href="/ui/offers/new/3" style="text-decoration:none;font-size:20px;">‚Üê</a>
    <div class="fw-black" style="font-weight:900;font-size:22px;letter-spacing:-.4px;">Verificaci√≥n</div>
    <div class="ms-auto muted" style="font-size:13px;">4/4</div>
  </div>
</div>

<!-- Formulario estilo iOS -->
<div class="card-soft overflow-hidden p-0 mt-3">
  <div class="px-3 py-2 bg-light border-bottom small fw-bold text-uppercase muted"
    style="letter-spacing:1px; font-size:11px;">
    PASO 4 ¬∑ PORTADA Y V√çDEO
  </div>

  <div class="p-4 text-center border-bottom bg-white">
    <p class="muted small mb-3">1. Primero, haz una <b>foto de portada</b> para el anuncio.</p>
    <label class="btn btn-outline-secondary pill d-inline-flex align-items-center gap-2 mb-3">
      üì∏ Hacer / Subir Foto
      <input id="wPhoto" type="file" accept="image/*" style="display:none"
        onchange="document.getElementById('photoLabel').textContent = this.files[0]?.name || 'Foto seleccionada';" />
    </label>
    <div id="photoLabel" class="small mb-4 text-secondary fw-bold"></div>

    <hr class="my-4">

    <p class="muted small mb-3">2. Ahora, graba un <b id="videoInfoLabel">v√≠deo corto (max 15s)</b> present√°ndote.</p>
    <label class="btn btn-outline-primary pill d-inline-flex align-items-center gap-2">
      üìπ Grabar / Subir V√≠deo
      <input id="wVideo" type="file" accept="video/*" style="display:none"
        onchange="document.getElementById('videoLabel').textContent = this.files[0]?.name || 'V√≠deo seleccionado';" />
    </label>
    <div id="videoLabel" class="small mt-2 text-primary fw-bold"></div>
  </div>

  <div class="p-3 bg-light">
    <div class="small fw-bold text-uppercase muted mb-2">RESUMEN DE LA OFERTA</div>
    <div id="summary" class="small text-dark" style="line-height:1.6;"></div>
  </div>

  <div class="p-3 border-top bg-white">
    <button class="btn btn-link text-danger w-100 text-decoration-none small" onclick="clearDraft()">üóë Eliminar
      borrador y empezar de cero</button>
  </div>
</div>

<div class="d-flex gap-2 mt-3">
  <a class="btn btn-light flex-grow-1 pill" href="/ui/offers/new/3">Atr√°s</a>
  <button class="btn btn-success flex-grow-1 pill" onclick="publish()">Publicar oferta</button>
</div>

<script>
  function wDraftKey() {
    const pid = localStorage.getItem("me_profile_id") || "";
    return "draft_offer_" + (pid || "anon");
  }
  function loadDraft() { try { return JSON.parse(localStorage.getItem(wDraftKey()) || "{}"); } catch (e) { return {}; } }
  function saveDraft(patch) {
    const d = loadDraft();
    const n = Object.assign({}, d, patch);
    localStorage.setItem(wDraftKey(), JSON.stringify(n));
    return n;
  }
  function clearDraft() {
    localStorage.removeItem(wDraftKey());
    renderSummary();
    alert("Borrador eliminado.");
  }
  function formatPrice(value) {
    if (value == null || value === "") return "0";
    try {
      let num = Math.floor(parseFloat(value));
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    } catch (e) { return value; }
  }
  function renderSummary() {
    const d = loadDraft();
    const s = document.getElementById("summary");
    const lines = [];
    if (d.category) lines.push(`<b>Categor√≠a:</b> ${d.category}`);
    if (d.title) lines.push(`<b>T√≠tulo:</b> ${d.title}`);
    if (d.specialty) lines.push(`<b>Especialidad:</b> ${d.specialty}`);
    if (d.zone_text) lines.push(`<b>Zona:</b> ${d.zone_text}`);
    if (d.service_radius_km) lines.push(`<b>Radio:</b> ${d.service_radius_km} km`);
    lines.push(`<b>Disponible ahora:</b> ${d.available_now ? "S√≠" : "No"}`);
    if (d.price != null) lines.push(`<b>Precio:</b> ${formatPrice(d.price)} ‚Ç¨`);
    if (d.rooms) lines.push(`<b>Habitaciones:</b> ${d.rooms}`);
    if (d.sqm) lines.push(`<b>Metros:</b> ${d.sqm} m¬≤`);
    if (d.bathrooms) lines.push(`<b>Ba√±os:</b> ${d.bathrooms}`);
    if (d.floor) lines.push(`<b>Planta:</b> ${d.floor}`);
    if (d.lift) lines.push(`<b>Ascensor:</b> S√≠`);
    if (d.terrace) lines.push(`<b>Terraza:</b> S√≠`);
    if (d.ac) lines.push(`<b>Aire Acond.:</b> S√≠`);
    if (d.parking) lines.push(`<b>Garaje:</b> S√≠`);

    if (d.carBrand) lines.push(`<b>Marca:</b> ${d.carBrand}`);
    if (d.carModel) lines.push(`<b>Modelo:</b> ${d.carModel}`);
    if (d.carYear) lines.push(`<b>A√±o:</b> ${d.carYear}`);
    if (d.carKm) lines.push(`<b>KM:</b> ${d.carKm}`);
    if (d.carCC) lines.push(`<b>Cilindrada:</b> ${d.carCC} cc`);
    if (d.carHp) lines.push(`<b>Potencia:</b> ${d.carHp} CV`);
    if (d.carFuel) lines.push(`<b>Combustible:</b> ${d.carFuel}`);
    if (d.carTrans) lines.push(`<b>Cambio:</b> Autom√°tico`);

    s.innerHTML = lines.join("<br>");
  }
  async function publish() {
    const profileId = localStorage.getItem("me_profile_id");
    const profileIdInt = parseInt(profileId);
    if (!profileId || isNaN(profileIdInt)) {
      alert("No se encontr√≥ un perfil v√°lido. Por favor, ve a Cuenta y selecciona tu perfil.");
      console.log("Profile ID in localStorage:", profileId);
      return;
    }

    const d = loadDraft();
    if (!d.category || !d.title) { alert("Faltan datos del paso 1."); return; }

    // VALIDACI√ìN ESPECIAL: Si es Venta, el video es OBLIGATORIO
    const isVenta = (d.category || "").includes("Venta") || (d.category || "").includes("Mercado");
    const videoFile = document.getElementById("wVideo").files[0];

    // En edici√≥n, el video puede ser opcional si ya existe (pero aqu√≠ simplificamos: si sube uno nuevo, se reemplaza)
    // Si es nuevo Y es venta, video obligatorio.
    // Si es edit, videoFile es null si no lo cambia... asumimos que ya tiene. 
    // TODO: Podr√≠amos comprobar si d.video_path existe, pero el draft no lo suele tener a menos que lo inyectemos.
    // Dashboard inyecta todo, as√≠ que d.video_path deber√≠a estar si venimos de edit.

    if (!d.editing_id && isVenta && !videoFile) {
      alert("‚ö†Ô∏è OBLIGATORIO: Para vender productos, debes subir un v√≠deo demostrativo.");
      return;
    }

    // 1) Payload
    const payload = {
      profile_id: profileIdInt,
      offer_kind: d.offer_type === 'sales' ? "PRODUCT" : "SERVICE", // Ajuste de fallback
      category: d.category,
      title: d.title,
      description: (d.description || "").trim() || null,
      price: (d.price == null || d.price === "" ? null : Number(d.price)),
      currency: "EUR",
      available_now: !!d.available_now,
      allergens: d.specialty ? String(d.specialty) : null,
      extra_info: (d.rooms || d.sqm || d.bathrooms || d.floor || d.lift || d.terrace || d.ac || d.parking || d.carBrand || d.carModel || d.carYear || d.carKm || d.carCC || d.carHp || d.carFuel || d.carTrans || d.operationType || d.zone_text) ? {
        zone_text: d.zone_text || null,
        operation_type: d.operationType || "Venta",
        rooms: d.rooms || null,
        sqm: d.sqm || null,
        bathrooms: d.bathrooms || null,
        floor: d.floor || null,
        lift: !!d.lift,
        terrace: !!d.terrace,
        ac: !!d.ac,
        parking: !!d.parking,
        car_brand: d.carBrand || null,
        car_model: d.carModel || null,
        car_year: d.carYear || null,
        car_km: d.carKm || null,
        car_cc: d.carCC || null,
        car_hp: d.carHp || null,
        car_fuel: d.carFuel || null,
        car_trans: !!d.carTrans
      } : null,
      status: d.status || "DRAFT" // Preservar status si editamos (o default DRAFT)
    };

    if (d.editing_id) {
      // --- MODO EDICI√ìN (PUT) ---
      console.log("Updating offer:", d.editing_id, payload);
      try {
        const r = await fetch(`/api/v1/offers/${d.editing_id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!r.ok) {
          const j = await r.json();
          throw new Error(j.detail || ("HTTP " + r.status));
        }
        // √âxito update
      } catch (e) {
        alert("Error actualizando oferta: " + e.message);
        return;
      }

      // Reutilizamos la ID para subir fotos/videos si las hay
      var offerId = d.editing_id;
      var isNew = false;

    } else {
      // --- MODO CREACI√ìN (POST) ---
      console.log("Creating offer:", payload);
      try {
        const r = await fetch("/api/v1/offers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!r.ok) {
          const msg = (typeof j.detail === 'string') ? j.detail : JSON.stringify(j.detail);
          throw new Error(msg || ("HTTP " + r.status));
        }
        var offerId = j.id;
        var isNew = true;
      } catch (e) {
        alert("Error creando oferta: " + e.message);
        return;
      }
    }

    // 2) Subir foto si existe (file input tiene prioridad)
    const photoFile = document.getElementById("wPhoto").files[0];
    if (photoFile) {
      try {
        const fd = new FormData();
        fd.append("file", photoFile);
        const rPhoto = await fetch(`/api/v1/offers/${offerId}/photo`, { method: "POST", body: fd });
        if (!rPhoto.ok) throw new Error("Error subiendo foto");
      } catch (e) {
        if (isNew) alert("Oferta creada, pero la foto fall√≥: " + e.message);
        else console.error("Foto upload fail", e.message); // En edit somos menos agresivos
      }
    }

    // 3) Subir v√≠deo si existe
    const videoFileActual = document.getElementById("wVideo").files[0];
    if (videoFileActual) {
      try {
        const fd = new FormData();
        fd.append("file", videoFileActual);
        const r2 = await fetch(`/api/v1/offers/${offerId}/video`, { method: "POST", body: fd });
        if (!r2.ok) throw new Error("Error subiendo v√≠deo");
      } catch (e) {
        if (isNew) alert("Oferta creada, pero el v√≠deo fall√≥: " + e.message);
        else alert("Error actualizando v√≠deo: " + e.message);
        // Si falla video en Edit, no bloqueamos tanto
      }
    }

    // 4) Submit / Finalizar
    // Si es New, hacemos submit para activar (aunque sea demo published)
    // Si es Edit, mantenemos status (ya enviado en payload) a menos que queramos forzar algo.
    // Para simplificar: Si es New -> submit. Si es Edit -> Nada (ya est√° guardado).

    if (isNew) {
      try {
        await fetch(`/api/v1/offers/${offerId}/submit`, { method: "POST" });
      } catch (e) { console.error("Submit fail", e); }
    }

    localStorage.removeItem(wDraftKey());
    alert(d.editing_id ? "¬°Cambios guardados!" : "¬°Oferta publicada!");
    location.href = "/ui/offers";
  }

  (function init() {
    // label perfil activo (base.html ya lo rellena, pero por si acaso)
    const pid = localStorage.getItem("me_profile_id");
    const el = document.getElementById("activeProfileLabel");
    if (pid && el) el.textContent = "#" + pid;

    const d = loadDraft();
    const vLabel = document.getElementById("videoInfoLabel");
    if (d.category && d.category.includes("Inmobiliaria")) {
      vLabel.innerHTML = "v√≠deo detallado (max 3 min)";
    }

    renderSummary();
  })();
</script>
{% endblock %}