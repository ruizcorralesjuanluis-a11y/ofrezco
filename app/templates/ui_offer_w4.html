{% extends "base.html" %}
{% block content %}
<div class="ios-screen">
  <div class="ios-section d-flex align-items-center gap-2">
    <a class="btn btn-link p-0" href="/ui/offers/new/3" style="text-decoration:none;font-size:20px;">‚Üê</a>
    <div class="fw-black" style="font-weight:900;font-size:22px;letter-spacing:-.4px;">Verificaci√≥n</div>
    <div class="ms-auto muted" style="font-size:13px;">4/4</div>
  </div>
</div>

<!-- Formulario estilo iOS -->
<div class="card-soft overflow-hidden p-0 mt-3">
  <div class="px-3 py-2 bg-light border-bottom small fw-bold text-uppercase muted"
    style="letter-spacing:1px; font-size:11px;">
    PASO 4 ¬∑ PORTADA Y V√çDEO
  </div>

  <div class="p-4 text-center border-bottom bg-white">
    <p class="muted small mb-3">1. Primero, haz una <b>foto de portada</b> para el anuncio.</p>
    <label class="btn btn-outline-secondary pill d-inline-flex align-items-center gap-2 mb-3">
      üì∏ Hacer / Subir Foto
      <input id="wPhoto" type="file" accept="image/*" style="display:none"
        onchange="document.getElementById('photoLabel').textContent = this.files[0]?.name || 'Foto seleccionada';" />
    </label>
    <div id="photoLabel" class="small mb-4 text-secondary fw-bold"></div>

    <hr class="my-4">

    <p class="muted small mb-3">2. Ahora, graba un <b id="videoInfoLabel">v√≠deo corto (max 15s)</b> present√°ndote.</p>
    <label class="btn btn-outline-primary pill d-inline-flex align-items-center gap-2">
      üìπ Grabar / Subir V√≠deo
      <input id="wVideo" type="file" accept="video/*" style="display:none"
        onchange="document.getElementById('videoLabel').textContent = this.files[0]?.name || 'V√≠deo seleccionado';" />
    </label>
    <div id="videoLabel" class="small mt-2 text-primary fw-bold"></div>
  </div>

  <div class="p-3 bg-light">
    <div class="small fw-bold text-uppercase muted mb-2">RESUMEN DE LA OFERTA</div>
    <div id="summary" class="small text-dark" style="line-height:1.6;"></div>
  </div>

  <div class="p-3 border-top bg-white">
    <button class="btn btn-link text-danger w-100 text-decoration-none small" onclick="clearDraft()">üóë Eliminar
      borrador y empezar de cero</button>
  </div>
</div>

<div class="d-flex gap-2 mt-3">
  <a class="btn btn-light flex-grow-1 pill" href="/ui/offers/new/3">Atr√°s</a>
  <button class="btn btn-success flex-grow-1 pill" onclick="publish()">Publicar oferta</button>
</div>

<script>
  function wDraftKey() {
    const pid = localStorage.getItem("me_profile_id") || "";
    return "draft_offer_" + (pid || "anon");
  }
  function loadDraft() { try { return JSON.parse(localStorage.getItem(wDraftKey()) || "{}"); } catch (e) { return {}; } }
  function saveDraft(patch) {
    const d = loadDraft();
    const n = Object.assign({}, d, patch);
    localStorage.setItem(wDraftKey(), JSON.stringify(n));
    return n;
  }
  function clearDraft() {
    localStorage.removeItem(wDraftKey());
    renderSummary();
    alert("Borrador eliminado.");
  }
  function formatPrice(value) {
    if (value == null || value === "") return "0";
    try {
      let num = Math.floor(parseFloat(value));
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    } catch (e) { return value; }
  }
  function renderSummary() {
    const d = loadDraft();
    const s = document.getElementById("summary");
    const lines = [];
    if (d.category) lines.push(`<b>Categor√≠a:</b> ${d.category}`);
    if (d.title) lines.push(`<b>T√≠tulo:</b> ${d.title}`);
    if (d.specialty) lines.push(`<b>Especialidad:</b> ${d.specialty}`);
    if (d.city) lines.push(`<b>Ciudad:</b> ${d.city}`);
    if (d.zone_text) lines.push(`<b>Zona:</b> ${d.zone_text}`);
    if (d.service_radius_km) lines.push(`<b>Radio:</b> ${d.service_radius_km} km`);
    lines.push(`<b>Disponible ahora:</b> ${d.available_now ? "S√≠" : "No"}`);
    if (d.price != null) lines.push(`<b>Precio:</b> ${formatPrice(d.price)} ‚Ç¨`);
    // CAMPOS DE INMOBILIARIA
    if (d.category && d.category.includes("Inmobiliaria")) {
      if (d.rooms) lines.push(`<b>Habitaciones:</b> ${d.rooms}`);
      if (d.sqm) lines.push(`<b>Metros:</b> ${d.sqm} m¬≤`);
      if (d.bathrooms) lines.push(`<b>Ba√±os:</b> ${d.bathrooms}`);
      if (d.floor) lines.push(`<b>Planta:</b> ${d.floor}`);
      if (d.lift) lines.push(`<b>Ascensor:</b> S√≠`);
      if (d.terrace) lines.push(`<b>Terraza:</b> S√≠`);
      if (d.ac) lines.push(`<b>Aire Acond.:</b> S√≠`);
      if (d.parking) lines.push(`<b>Garaje:</b> S√≠`);
    }

    // CAMPOS DE MOTOR
    if (d.category && d.category.includes("Veh√≠culos")) {
      if (d.carBrand) lines.push(`<b>Marca:</b> ${d.carBrand}`);
      if (d.carModel) lines.push(`<b>Modelo:</b> ${d.carModel}`);
      if (d.carYear) lines.push(`<b>A√±o:</b> ${d.carYear}`);
      if (d.carKm) lines.push(`<b>KM:</b> ${d.carKm}`);
      if (d.carCC) lines.push(`<b>Cilindrada:</b> ${d.carCC} cc`);
      if (d.carHp) lines.push(`<b>Potencia:</b> ${d.carHp} CV`);
      if (d.carFuel) lines.push(`<b>Combustible:</b> ${d.carFuel}`);
      if (d.carTrans) lines.push(`<b>Cambio:</b> Autom√°tico`);
    }

    s.innerHTML = lines.join("<br>");
  }
  async function publish() {
    const profileId = localStorage.getItem("me_profile_id");
    const profileIdInt = parseInt(profileId);
    if (!profileId || isNaN(profileIdInt)) {
      alert("No se encontr√≥ un perfil v√°lido. Por favor, ve a Cuenta y selecciona tu perfil.");
      console.log("Profile ID in localStorage:", profileId);
      return;
    }

    const d = loadDraft();
    if (!d.category || !d.title) { alert("Faltan datos del paso 1."); return; }

    // VALIDACI√ìN ESPECIAL: Si es Venta, el video es OBLIGATORIO
    const isVenta = (d.category || "").includes("Venta") || (d.category || "").includes("Mercado");
    const videoFile = document.getElementById("wVideo").files[0];

    if (isVenta && !videoFile) {
      alert("‚ö†Ô∏è OBLIGATORIO: Para vender productos, debes subir un v√≠deo demostrativo.");
      return;
    }

    // 1) Crear oferta DRAFT
    // 1) Crear oferta DRAFT
    const cat = d.category || "";
    const isInmo = cat.includes("Inmobiliaria");
    const isMotor = cat.includes("Veh√≠culos");

    // Construir extra_info LIMPIO basado exclusivamente en la categor√≠a
    let safeExtra = {
      city: d.city || null,
      zone_text: d.zone_text || null
    }; // City y Zone siempre son √∫tiles

    if (isInmo) {
      Object.assign(safeExtra, {
        operation_type: d.operationType || "Venta",
        rooms: d.rooms || null,
        sqm: d.sqm || null,
        bathrooms: d.bathrooms || null,
        floor: d.floor || null,
        lift: !!d.lift,
        terrace: !!d.terrace,
        ac: !!d.ac,
        parking: !!d.parking
      });
    } else if (isMotor) {
      Object.assign(safeExtra, {
        car_brand: d.carBrand || null,
        car_model: d.carModel || null,
        car_year: d.carYear || null,
        car_km: d.carKm || null,
        car_cc: d.carCC || null,
        car_hp: d.carHp || null,
        car_fuel: d.carFuel || null,
        car_trans: !!d.carTrans
      });
    } else {
      // Mercadillo / Servicios / Otros
      // No a√±adimos nada espec√≠fico de Inmo/Motor para evitar "contaminaci√≥n"
      // Si acaso, operation_type podr√≠a ser √∫til si es venta/alquiler general
    }

    const payload = {
      profile_id: profileIdInt,
      offer_kind: "SERVICE",
      category: d.category,
      title: d.title,
      description: (d.description || "").trim() || null,
      price: (d.price == null || d.price === "" ? null : Number(d.price)),
      currency: "EUR",
      available_now: !!d.available_now,
      allergens: d.specialty ? String(d.specialty) : null,
      allergens: d.specialty ? String(d.specialty) : null,
      extra_info: safeExtra
    };

    // Logic for Status Update
    if (d.status) {
      let s = d.status;
      if (s === "Disponible") s = "PUBLISHED";
      payload.status = s;
    }

    console.log("Publishing payload:", payload);

    // 4) Enviar a revisi√≥n
    // Si era UPDATE, no hacemos POST submit (ya se hizo update en paso 1 o aqu√≠ si movi√©ramos l√≥gica)
    // PERO espera, publish hace el SAVE (create/update).
    // Si es CREATE -> POST /offers -> Uploads -> POST /submit
    // Si es UPDATE -> PUT /offers/{id} -> Uploads -> (Reset status? No).

    // LOGICA PREVIA DE SAVE (POST vs PUT)
    // ---------------------------------------------------------
    const isEdit = !!d.editing_id;
    let method = "POST";
    let url = "/api/v1/offers";

    if (isEdit) {
      method = "PUT";
      url = `/api/v1/offers/${d.editing_id}`;
    }

    console.log(`${isEdit ? "Updating" : "Creating"} offer...`);

    let offer;
    try {
      const r = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!r.ok) {
        console.error("Server error detail:", j);
        const msg = (typeof j.detail === 'string') ? j.detail : JSON.stringify(j.detail);
        throw new Error(msg || ("HTTP " + r.status));
      }
      offer = j;
    } catch (e) {
      alert(`Error ${isEdit ? "actualizando" : "creando"} oferta: ` + e.message);
      return;
    }

    const offerId = offer.id;

    // 2) Subir foto si existe (solo si el usuario seleccion√≥ nueva)
    const photoFile = document.getElementById("wPhoto").files[0];
    if (photoFile) {
      try {
        const fd = new FormData();
        fd.append("file", photoFile);
        const rPhoto = await fetch(`/api/v1/offers/${offerId}/photo`, { method: "POST", body: fd });
        if (!rPhoto.ok) throw new Error("Error subiendo foto");
      } catch (e) {
        alert("Oferta guardada, pero la foto fall√≥: " + e.message);
      }
    }

    // 3) Subir v√≠deo si existe (solo si seleccion√≥ nuevo)
    const videoFileActual = document.getElementById("wVideo").files[0];
    if (videoFileActual) {
      try {
        const fd = new FormData();
        fd.append("file", videoFileActual);
        const r2 = await fetch(`/api/v1/offers/${offerId}/video`, { method: "POST", body: fd });
        if (!r2.ok) throw new Error("Error subiendo v√≠deo");
      } catch (e) {
        alert("Oferta guardada, pero el v√≠deo fall√≥: " + e.message);
        return;
      }
    }

    // 4) Enviar a revisi√≥n (SOLO SI ES CREATE)
    // Si es UPDATE, asumimos que mantiene estado o que el backend decide.
    // El endpoint PUT no cambia estado a PUBLISHED expl√≠citamente, pero el usuario no pidi√≥ re-review.
    if (!isEdit) {
      try {
        const r3 = await fetch(`/api/v1/offers/${offerId}/submit`, { method: "POST" });
        if (!r3.ok) {
          // Si falla el submit, la oferta queda en DRAFT.
          console.warn("Submit failed");
        }
      } catch (e) {
        console.error("Error submitting:", e);
      }
    }

    localStorage.removeItem(wDraftKey());
    alert(isEdit ? "¬°Oferta actualizada con √©xito!" : "¬°Oferta publicada con √©xito!");
    location.href = "/ui/offers";
  }

  (function init() {
    // label perfil activo
    const pid = localStorage.getItem("me_profile_id");
    const el = document.getElementById("activeProfileLabel");
    if (pid && el) el.textContent = "#" + pid;

    const d = loadDraft();
    const vLabel = document.getElementById("videoInfoLabel");
    if (d.category && d.category.includes("Inmobiliaria")) {
      vLabel.innerHTML = "v√≠deo detallado (max 3 min)";
    }

    // Cambiar texto bot√≥n si es edici√≥n
    if (d.editing_id) {
      const btn = document.querySelector("button[onclick='publish()']");
      if (btn) btn.textContent = "Guardar Cambios";
    }

    renderSummary();
  })();
</script>
{% endblock %}