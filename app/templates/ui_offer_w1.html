{% extends "base.html" %}
{% block content %}


<!-- Formulario estilo iOS -->
<div class="card-soft overflow-hidden p-0 mt-3">
  <div class="px-3 py-2 bg-light border-bottom small fw-bold text-uppercase muted"
    style="letter-spacing:1px; font-size:11px;">
    PASO 1 · INFORMACIÓN BÁSICA
  </div>

  <ul class="ios-list m-0 p-0" style="list-style:none;">
    <!-- Categoría -->
    <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
      <span class="ios-label">Categoría</span>
      <select id="wCategory" class="ios-input text-end" style="width:60%; direction:rtl; background:transparent;">
        <option value="">Seleccionar...</option>
        {% for main, subs in categories.items() %}
        <optgroup label="{{ main }}">
          {% for sub in subs %}
          <option value="{{ sub }}">{{ sub }}</option>
          {% endfor %}
        </optgroup>
        {% endfor %}
      </select>
    </li>

    <!-- Título -->
    <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
      <span class="ios-label">Título</span>
      <input id="wTitle" class="ios-input text-end" style="width:60%;" placeholder="Ej. Electricista barato" />
    </li>

    <!-- Especialidad -->
    <li class="ios-row d-flex align-items-center justify-content-between p-3" id="rowSpecialty" {% if
      offer_type=='sales' %} style="display:none !important;" {% endif %}>
      <span class="ios-label">Especialidad</span>
      <input id="wSpecialty" class="ios-input text-end" style="width:60%;" placeholder="Opcional" />
    </li>

    <!-- BLOQUE INMOBILIARIA -->
    <div id="blockRealEstate" style="display:none;">
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-top border-bottom">
        <span class="ios-label">Tipo de operación</span>
        <select id="wOperationType" class="ios-input text-end"
          style="width:60%; direction:rtl; background:transparent;">
          <option value="Venta">Venta</option>
          <option value="Alquiler">Alquiler</option>
        </select>
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Habitaciones</span>
        <input type="number" id="wRooms" class="ios-input text-end" style="width:60%;" placeholder="0" />
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Metros (m²)</span>
        <input type="number" id="wSqm" class="ios-input text-end" style="width:60%;" placeholder="0" />
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Baños</span>
        <input type="number" id="wBathrooms" class="ios-input text-end" style="width:60%;" placeholder="0" />
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Planta</span>
        <input type="number" id="wFloor" class="ios-input text-end" style="width:60%;" placeholder="0" />
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Ascensor</span>
        <div class="form-check form-switch m-0">
          <input class="form-check-input" type="checkbox" id="wLift">
        </div>
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Terraza</span>
        <div class="form-check form-switch m-0">
          <input class="form-check-input" type="checkbox" id="wTerrace">
        </div>
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Aire Acond.</span>
        <div class="form-check form-switch m-0">
          <input class="form-check-input" type="checkbox" id="wAC">
        </div>
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Garaje</span>
        <div class="form-check form-switch m-0">
          <input class="form-check-input" type="checkbox" id="wParking">
        </div>
      </li>
    </div>
    <!-- BLOQUE MOTOR -->
    <div id="blockMotor" style="display:none;">
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-top border-bottom">
        <span class="ios-label">Marca</span>
        <select id="wCarBrand" class="ios-input text-end" style="width:60%; direction:rtl; background:transparent;">
          <option value="">Seleccionar...</option>
        </select>
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Modelo</span>
        <select id="wCarModel" class="ios-input text-end" style="width:60%; direction:rtl; background:transparent;">
          <option value="">Seleccionar marca primero...</option>
        </select>
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Año</span>
        <input type="number" id="wCarYear" class="ios-input text-end" style="width:60%;" placeholder="2020" />
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Kilómetros</span>
        <input type="number" id="wCarKm" class="ios-input text-end" style="width:60%;" placeholder="0" />
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Cilindrada (cc)</span>
        <input type="number" id="wCarCC" class="ios-input text-end" style="width:60%;" placeholder="1600" />
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Potencia (CV)</span>
        <input type="number" id="wCarHp" class="ios-input text-end" style="width:60%;" placeholder="110" />
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Combustible</span>
        <select id="wCarFuel" class="ios-input text-end" style="width:60%; direction:rtl; background:transparent;">
          <option value="Gasolina">Gasolina</option>
          <option value="Diésel">Diésel</option>
          <option value="Híbrido">Híbrido</option>
          <option value="Eléctrico">Eléctrico</option>
          <option value="Otros">Otros</option>
        </select>
      </li>
      <li class="ios-row d-flex align-items-center justify-content-between p-3 border-bottom">
        <span class="ios-label">Cambio Automático</span>
        <div class="form-check form-switch m-0">
          <input class="form-check-input" type="checkbox" id="wCarTrans">
        </div>
      </li>
    </div>
  </ul>
</div>

<div class="d-flex gap-2 mt-3">
  <a class="btn btn-light flex-grow-1 pill" href="/ui">Cancelar</a>
  <button class="btn btn-success flex-grow-1 pill" onclick="wNext()">Siguiente</button>
</div>

<script>
  function wDraftKey() {
    const pid = localStorage.getItem("me_profile_id") || "";
    return "draft_offer_" + (pid || "anon");
  }
  function loadDraft() {
    try { return JSON.parse(localStorage.getItem(wDraftKey()) || "{}"); } catch (e) { return {}; }
  }
  function saveDraft(patch) {
    const d = loadDraft();
    const n = Object.assign({}, d, patch);
    localStorage.setItem(wDraftKey(), JSON.stringify(n));
    return n;
  }
  function wNext() {
    const catSelect = document.getElementById("wCategory");
    const category = catSelect.value.trim();
    const title = document.getElementById("wTitle").value.trim();
    const specialty = document.getElementById("wSpecialty").value.trim();
    const rooms = document.getElementById("wRooms").value;
    const sqm = document.getElementById("wSqm").value;
    const bathrooms = document.getElementById("wBathrooms").value;

    const floor = document.getElementById("wFloor").value;
    const lift = document.getElementById("wLift").checked;
    const terrace = document.getElementById("wTerrace").checked;
    const ac = document.getElementById("wAC").checked;
    const parking = document.getElementById("wParking").checked;

    const carBrand = document.getElementById("wCarBrand").value.trim();
    const carModel = document.getElementById("wCarModel").value.trim();
    const carYear = document.getElementById("wCarYear").value;
    const carKm = document.getElementById("wCarKm").value;
    const carCC = document.getElementById("wCarCC").value;
    const carHp = document.getElementById("wCarHp").value;
    const carFuel = document.getElementById("wCarFuel").value;
    const carTrans = document.getElementById("wCarTrans").checked;

    if (!category) { alert("Selecciona una categoría."); return; }
    if (title.length < 3) { alert("Escribe un título (mín. 3 caracteres)."); return; }

    // Obtener el grupo (categoría padre)
    const selectedOption = catSelect.options[catSelect.selectedIndex];
    const parentGroup = selectedOption.parentElement;
    const category_group = parentGroup.tagName === 'OPTGROUP' ? parentGroup.label : "Otros";

    // Guardamos también el tipo de oferta para usarlo en pasos siguientes
    const offerType = '{{ offer_type }}';
    saveDraft({
      category, category_group, title, specialty, offer_type: offerType,
      rooms, sqm, bathrooms,
      floor, lift, terrace, ac, parking,
      carBrand, carModel, carYear, carKm, carCC, carHp, carFuel, carTrans
    });

    location.href = "/ui/offers/new/2";
  }
  (function init() {
    // Definimos el tipo de flujo actual (si existe)
    const offerType = '{{ offer_type }}';
    const salesCategories = {{ sales_categories | tojson | safe
  }};

  // Lógica de filtrado de categorías por URL
  const urlParams = new URLSearchParams(window.location.search);
  const exclude = urlParams.get("exclude_cat");
  const exclude2 = urlParams.get("exclude_cat2");
  const fixed = urlParams.get("fixed_cat");
  const catSelect = document.getElementById("wCategory");

  if (exclude || exclude2 || fixed) {
    const options = Array.from(catSelect.options);
    options.forEach(opt => {
      if (!opt.value) return;

      const parentGroup = opt.parentElement;
      const groupLabel = (parentGroup.tagName === 'OPTGROUP') ? parentGroup.label : "";

      let shouldRemove = false;

      // EXCLUSIÓN: En Mercadillo no queremos Inmo ni Motor
      if (fixed === "Mercado de Segunda Mano (Venta)") {
        if (opt.value === "Inmobiliaria (Pisos/Locales)" || opt.value === "Vehículos y Motor") {
          shouldRemove = true;
        }
      }

      if (exclude && (opt.value === exclude || groupLabel === exclude)) {
        shouldRemove = true;
      }
      if (exclude2 && (opt.value === exclude2 || groupLabel === exclude2)) {
        shouldRemove = true;
      }

      // Si hay un fixed, se queda si coincide con el valor O con la etiqueta del grupo
      if (fixed && fixed !== "Mercado de Segunda Mano (Venta)") {
        if (opt.value !== fixed && groupLabel !== fixed) {
          shouldRemove = true;
        }
      }

      if (shouldRemove) {
        opt.remove();
      }
    });

    // Limpiar optgroups vacíos
    Array.from(catSelect.querySelectorAll('optgroup')).forEach(og => {
      if (og.children.length === 0) og.remove();
    });

    // Si solo queda una opción real, seleccionarla automáticamente
    const validOptions = Array.from(catSelect.options).filter(o => o.value);
    if (validOptions.length === 1) {
      catSelect.value = validOptions[0].value;
      // Si ya está prefijado un valor único y específico (Inmo o Motor), ocultamos la fila
      if (fixed === "Inmobiliaria (Pisos/Locales)" || fixed === "Vehículos y Motor") {
        catSelect.closest("li").style.display = "none";
      }
    }
  }

  // Cargar borrador
  let d = loadDraft();

  // Lógica de limpieza preventiva si cambiamos de flujo
  if (d && Object.keys(d).length > 0) {
    let mismatch = false;

    // Si estamos en un modo específico (sales o service)
    if (offerType) {
      // 1. Mismatch de TIPO DECLARADO
      if (d.offer_type !== offerType) {
        mismatch = true;
      }
      // 2. Mismatch de CONTENIDO (Categoría incompatible con el modo)
      else if (d.category) {
        const isCatVenta = salesCategories.includes(d.category);
        if (offerType === 'sales' && !isCatVenta) mismatch = true;
        if (offerType === 'service' && isCatVenta) mismatch = true;
      }
    }
    // Fallback legacy (sin offerType en URL)
    else if (d.category) {
      // Si no hay modo forzado, no hacemos nada agresivo
    }

    if (mismatch) {
      console.log("Limpiando borrador. Mode:", offerType, "Stored:", d.offer_type);
      localStorage.removeItem(wDraftKey());
      d = {}; // Reiniciar variable local y UI

      // Limpiar campos visuales
      document.getElementById("wCategory").value = "";
      document.getElementById("wTitle").value = "";
      document.getElementById("wSpecialty").value = "";
    }
  }

  // ADAPTACIÓN DE TEXTOS PARA 'VENTAS'
  if (offerType === 'sales') {
    const wTitle = document.getElementById("wTitle");
    if (fixed === "Inmobiliaria (Pisos/Locales)" || fixed === "Vehículos y Motor") {
      wTitle.placeholder = "";
    } else {
      wTitle.placeholder = "Ej. iPhone 12, Sofá cama...";
    }
    // Forzar ocultar specialty
    document.getElementById("rowSpecialty").style.setProperty("display", "none", "important");
  }

  const carData = {
    "SEAT": ["Arona", "Ibiza", "Leon", "Ateca", "Tarraco", "Alhambra", "Otros"],
    "Renault": ["Clio", "Captur", "Megane", "Austral", "Arkana", "Zoe", "Otros"],
    "Peugeot": ["208", "2008", "308", "3008", "508", "5008", "Otros"],
    "Volkswagen": ["Golf", "Polo", "T-Roc", "Tiguan", "Passat", "ID.3", "ID.4", "Otros"],
    "Toyota": ["Corolla", "Yaris", "C-HR", "RAV4", "Hilux", "Land Cruiser", "Otros"],
    "BMW": ["Serie 1", "Serie 2", "Serie 3", "Serie 4", "Serie 5", "X1", "X3", "X5", "Otros"],
    "Mercedes-Benz": ["Clase A", "Clase B", "Clase C", "Clase E", "GLA", "GLC", "GLE", "Otros"],
    "Audi": ["A1", "A3", "A4", "A5", "A6", "Q2", "Q3", "Q5", "Otros"],
    "Ford": ["Fiesta", "Focus", "Kuga", "Puma", "Mustang", "Custom", "Otros"],
    "Citroën": ["C3", "C4", "C5 Aircross", "Berlingo", "Otros"],
    "Hyundai": ["i10", "i20", "i30", "Tucson", "Kona", "Ioniq", "Otros"],
    "Kia": ["Picanto", "Rio", "Ceed", "Sportage", "Niro", "EV6", "Otros"],
    "Dacia": ["Sandero", "Duster", "Jogger", "Spring", "Otros"],
    "Fiat": ["500", "Panda", "Tipo", "Ducato", "Otros"],
    "Opel": ["Corsa", "Astra", "Mokka", "Grandland", "Otros"],
    "Nissan": ["Micra", "Juke", "Qashqai", "X-Trail", "Leaf", "Otros"],
    "Volvo": ["XC40", "XC60", "XC90", "V40", "S60", "Otros"],
    "Tesla": ["Model 3", "Model Y", "Model S", "Model X", "Otros"],
    "Porsche": ["911", "Cayenne", "Macan", "Taycan", "Panamera", "Otros"],
    "Jeep": ["Renegade", "Compass", "Wrangler", "Cherokee", "Otros"],
    "Mini": ["Hatch", "Countryman", "Clubman", "Otros"],
    "Land Rover": ["Evoque", "Velar", "Defender", "Discovery", "Otros"],
    "Lexus": ["UX", "NX", "RX", "ES", "Otros"],
    "Mazda": ["Mazda2", "Mazda3", "CX-30", "CX-5", "MX-5", "Otros"],
    "Skoda": ["Fabia", "Octavia", "Superb", "Kamiq", "Karoq", "Kodiaq", "Otros"],
    "Alfa Romeo": ["Giulia", "Stelvio", "Tonale", "Otros"],
    "Cupra": ["Formentor", "Leon", "Born", "Ateca", "Otros"],
    "Honda": ["Civic", "HR-V", "CR-V", "Jazz", "Otros"],
    "Suzuki": ["Swift", "Vitara", "Ignis", "Jimny", "Otros"],
    "Mitsubishi": ["ASX", "Eclipse Cross", "Outlander", "L200", "Otros"],
    "MG": ["ZS", "HS", "MG4", "MG5", "Marvel R", "Otros"],
    "BYD": ["Atto 3", "Han", "Tang", "Dolphin", "Otros"],
    "Jaguar": ["XE", "XF", "E-Pace", "F-Pace", "I-Pace", "F-Type", "Otros"],
    "Subaru": ["Impreza", "XV", "Forester", "Outback", "Solterra", "Otros"],
    "Smart": ["Fortwo", "Forfour", "#1", "#3", "Otros"],
    "DS": ["DS 3", "DS 4", "DS 7", "DS 9", "Otros"],
    "Maserati": ["Ghibli", "Levante", "Quattroporte", "Grecale", "Otros"],
    "Ferrari": ["296 GTB", "SF90 Stradale", "Roma", "F8", "Purosangue", "Otros"],
    "Lamborghini": ["Urus", "Huracán", "Revuelto", "Otros"],
    "Aston Martin": ["Vantage", "DB11", "DBS", "DBX", "Otros"],
    "SsangYong / KGM": ["Tivoli", "Korando", "Rexton", "Torres", "Otros"],
    "Lynk & Co": ["01", "Otros"],
    "Polestar": ["2", "3", "Otros"],
    "Otros": ["Otros"]
  };

  const brandSelect = document.getElementById("wCarBrand");
  const modelSelect = document.getElementById("wCarModel");

  // Poblar Marcas
  Object.keys(carData).sort((a, b) => {
    if (a === "Otros") return 1;
    if (b === "Otros") return -1;
    return a.localeCompare(b);
  }).forEach(brand => {
    const opt = document.createElement("option");
    opt.value = brand;
    opt.textContent = brand;
    brandSelect.appendChild(opt);
  });

  // Manejar cambio de marca
  brandSelect.addEventListener("change", function () {
    const models = carData[this.value] || ["Otros"];
    modelSelect.innerHTML = '<option value="">Seleccionar...</option>';
    models.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      modelSelect.appendChild(opt);
    });
  });

  if (d.category) document.getElementById("wCategory").value = d.category;
  if (d.title) document.getElementById("wTitle").value = d.title;
  if (d.specialty) document.getElementById("wSpecialty").value = d.specialty;
  if (d.operationType) document.getElementById("wOperationType").value = d.operationType;
  if (d.rooms) document.getElementById("wRooms").value = d.rooms;
  if (d.sqm) document.getElementById("wSqm").value = d.sqm;
  if (d.bathrooms) document.getElementById("wBathrooms").value = d.bathrooms;
  if (d.floor) document.getElementById("wFloor").value = d.floor;
  if (d.lift) document.getElementById("wLift").checked = d.lift;
  if (d.terrace) document.getElementById("wTerrace").checked = d.terrace;
  if (d.ac) document.getElementById("wAC").checked = d.ac;
  if (d.parking) document.getElementById("wParking").checked = d.parking;

  // Cargar marca y disparar evento para cargar modelos
  if (d.carBrand) {
    brandSelect.value = d.carBrand;
    brandSelect.dispatchEvent(new Event("change"));
    if (d.carModel) modelSelect.value = d.carModel;
  }
  if (d.carYear) document.getElementById("wCarYear").value = d.carYear;
  if (d.carKm) document.getElementById("wCarKm").value = d.carKm;
  if (d.carCC) document.getElementById("wCarCC").value = d.carCC;
  if (d.carHp) document.getElementById("wCarHp").value = d.carHp;
  if (d.carFuel) document.getElementById("wCarFuel").value = d.carFuel;
  if (d.carTrans) document.getElementById("wCarTrans").checked = d.carTrans;

  // Detectar cambio de categoría para ocultar/mostrar especialidad
  document.getElementById("wCategory").addEventListener("change", function () {
    const val = this.value;
    const isInmob = val.includes("Inmobiliaria");
    const isMotor = val.includes("Vehículos");
    const blockRE = document.getElementById("blockRealEstate");
    const blockMT = document.getElementById("blockMotor");
    const rowSpec = document.getElementById("rowSpecialty");

    // Si estamos en modo "sales" estricto, ocultamos siempre
    if (offerType === 'sales') {
      rowSpec.style.setProperty("display", "none", "important");
      document.getElementById("wSpecialty").value = "";
    } else {
      const isCatVenta = salesCategories.includes(val);
      if (isCatVenta) {
        rowSpec.style.setProperty("display", "none", "important");
        document.getElementById("wSpecialty").value = "";
      } else {
        rowSpec.style.display = "flex";
      }
    }

    if (isInmob) {
      blockRE.style.display = "block";
    } else {
      blockRE.style.display = "none";
    }

    if (isMotor) {
      blockMT.style.display = "block";
    } else {
      blockMT.style.display = "none";
    }
  });

  // Trigger para ajustar
  if (document.getElementById("wCategory").value) {
    document.getElementById("wCategory").dispatchEvent(new Event("change"));
  }
}) ();
</script>
{% endblock %}