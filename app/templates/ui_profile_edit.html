{% extends "base.html" %}
{% block content %}

<style>
    .edit-header {
        text-align: center;
        padding: 30px 20px;
        background: #fff;
    }

    .avatar-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #f3f4f6;
        margin-bottom: 15px;
    }

    .camera-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #e5e7eb;
        color: #1f2937;
        padding: 8px 16px;
        border-radius: 30px;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
    }
</style>

<div class="edit-header">
    <img id="preview" src="{{ p.photo or 'https://via.placeholder.com/100' }}" class="avatar-preview">
    <br>
    <!-- Input oculto -->
    <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="uploadPhoto()">

    <label for="fileInput" class="camera-btn">
        ðŸ“¸ Cambiar Foto
    </label>
</div>

<div class="p-4">
    <label class="form-label fw-bold">Sobre mÃ­ (DescripciÃ³n)</label>
    <textarea id="descInput" class="form-control" rows="5"
        placeholder="CuÃ©ntanos quÃ© sabes hacer, tu experiencia...">{{ p.description or '' }}</textarea>
    <div class="form-text">Esto es lo primero que verÃ¡n tus clientes.</div>

    <button class="btn btn-dark w-100 pill py-3 fw-bold mt-4" onclick="saveDesc()">
        Guardar cambios
    </button>

    <a href="/ui/profile/{{ p.id }}" class="btn btn-outline-secondary w-100 pill py-3 mt-3">
        Cancelar
    </a>
</div>

<script>
    const profileId = {{ p.id }};

    async function uploadPhoto() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        // Feedback visual
        document.getElementById('preview').style.opacity = 0.5;

        try {
            const res = await fetch(`/api/v1/profiles/${profileId}/photo`, {
                method: "POST",
                body: formData
            });
            if (!res.ok) throw new Error("Error upload");
            const data = await res.json();

            // Actualizar imagen
            document.getElementById('preview').src = data.photo_url + "?t=" + new Date().getTime(); // force refresh
            alert("Â¡Foto actualizada!");
        } catch (e) {
            alert("Error al subir foto: " + e);
        } finally {
            document.getElementById('preview').style.opacity = 1;
        }
    }

    async function saveDesc() {
        const desc = document.getElementById('descInput').value;
        try {
            const res = await fetch(`/api/v1/profiles/${profileId}/description`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ description: desc })
            });
            if (res.ok) {
                alert("DescripciÃ³n guardada");
                location.href = `/ui/profile/${profileId}`;
            } else {
                alert("Error al guardar");
            }
        } catch (e) {
            alert("Error: " + e);
        }
    }
</script>

{% endblock %}