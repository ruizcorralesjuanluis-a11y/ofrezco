{% extends "base.html" %}
{% block content %}
<div class="row g-4">
  <div class="col-12">
    <div class="card-soft p-4">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
          <div class="badge badge-soft mb-2">Panel</div>
          <h2 class="fw-bold mb-1">Gestiona tu perfil y publica ofertas</h2>
          <div class="muted">Todo agrupado: perfil → oferta → listado.</div>
        </div>
        <a class="btn btn-outline-dark rounded-2xl" href="/docs">Abrir API</a>
      </div>
    </div>
  </div>

  <!-- PERFIL -->
  <div class="col-lg-6">
    <div class="card-soft p-4 h-100">
      <h4 class="fw-bold mb-3">1) Tu perfil</h4>

      <label class="form-label">Selecciona un perfil (no escribir IDs)</label>
      <div class="d-flex gap-2">
        <select id="profile_select" class="form-select"></select>
        <button class="btn btn-outline-dark rounded-2xl" onclick="loadSelectedProfile()">Cargar</button>
      </div>
      <div class="form-text mb-3">Si no tienes ninguno, crea uno abajo.</div>

      <div class="row g-2">
        <div class="col-12">
          <label class="form-label">User ID</label>
          <input id="user_id" class="form-control" placeholder="Ej. 1">
          <div class="form-text">De momento lo ponemos manual. Luego lo haremos con login.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Tipo</label>
          <select id="profile_type" class="form-select">
            <option value="COMUNITARIO">Comunitario</option>
            <option value="PRO">Profesional</option>
            <option value="AMBOS">Ambos</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Disponible ahora</label>
          <select id="profile_available" class="form-select">
            <option value="true">Sí</option>
            <option value="false" selected>No</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Descripción</label>
          <textarea id="profile_desc" class="form-control" rows="3" placeholder="Ej. Hago croquetas / Soy electricista..."></textarea>
        </div>

        <div class="col-12">
          <label class="form-label">Video URL (opcional)</label>
          <input id="profile_video" class="form-control" placeholder="https://...">
        </div>

        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-brand rounded-2xl px-4" onclick="saveProfile()">Guardar perfil</button>
        </div>

        <div class="col-12">
          <pre id="profile_result" class="mt-3 p-3 rounded-2xl bg-light border" style="display:none;"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- OFERTA -->
  <div class="col-lg-6">
    <div class="card-soft p-4 h-100">
      <h4 class="fw-bold mb-3">2) Publicar oferta</h4>

      <div class="row g-2">
        <div class="col-12">
          <label class="form-label">Perfil seleccionado</label>
          <input id="offer_profile_id" class="form-control" placeholder="Se rellena al seleccionar perfil" readonly>
        </div>

        <div class="col-md-6">
          <label class="form-label">Tipo</label>
          <select id="offer_kind" class="form-select">
            <option value="SERVICIO">Servicio (Profesional)</option>
            <option value="COMIDA">Comida (Comunitario)</option>
            <option value="AYUDA">Ayuda (Comunitario)</option>
            <option value="PRODUCTO">Producto (Comunitario)</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Disponible ahora</label>
          <select id="offer_available" class="form-select">
            <option value="true">Sí</option>
            <option value="false" selected>No</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Categoría</label>
          <input id="offer_category" class="form-control" placeholder="Electricidad / Comida casera">
        </div>

        <div class="col-md-6">
          <label class="form-label">Título</label>
          <input id="offer_title" class="form-control" placeholder="Electricista urgente / Croquetas caseras hoy">
        </div>

        <div class="col-12">
          <label class="form-label">Descripción</label>
          <textarea id="offer_desc" class="form-control" rows="3" placeholder="Detalles, horario, zona, etc."></textarea>
        </div>

        <div class="col-md-4">
          <label class="form-label">Precio (opcional)</label>
          <input id="offer_price" type="number" step="0.01" class="form-control" placeholder="8.00">
        </div>

        <div class="col-md-2">
          <label class="form-label">Moneda</label>
          <input id="offer_currency" class="form-control" value="EUR">
        </div>

        <div class="col-md-6">
          <label class="form-label">Alérgenos (solo comida)</label>
          <input id="offer_allergens" class="form-control" placeholder="gluten, leche, huevo...">
        </div>

        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-brand rounded-2xl px-4" onclick="createOffer()">Publicar oferta</button>
          <button class="btn btn-outline-dark rounded-2xl" onclick="loadMyOffers()">Ver mis ofertas</button>
        </div>

        <div class="col-12">
          <pre id="offer_result" class="mt-3 p-3 rounded-2xl bg-light border" style="display:none;"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- LISTADO -->
  <div class="col-12">
    <div class="card-soft p-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="fw-bold mb-0">3) Mis ofertas</h4>
        <button class="btn btn-outline-dark rounded-2xl" onclick="loadMyOffers()">Actualizar</button>
      </div>
      <div id="my_offers" class="vstack gap-3"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let PROFILES = [];

async function fetchProfiles(){
  const res = await fetch("/api/v1/profiles");
  PROFILES = await res.json();

  const sel = document.getElementById("profile_select");
  sel.innerHTML = "";

  if (PROFILES.length === 0){
    sel.innerHTML = `<option value="">(No hay perfiles aún)</option>`;
    return;
  }

  for (const p of PROFILES){
    sel.innerHTML += `<option value="${p.id}">Perfil #${p.id} · ${p.profile_type} · user ${p.user_id}</option>`;
  }

  // autoselecciona el primero
  sel.value = PROFILES[0].id;
  loadSelectedProfile();
}

function loadSelectedProfile(){
  const id = Number(document.getElementById("profile_select").value);
  const p = PROFILES.find(x => x.id === id);
  if (!p) return;

  document.getElementById("offer_profile_id").value = p.id;
  document.getElementById("user_id").value = p.user_id;
  document.getElementById("profile_type").value = p.profile_type;
  document.getElementById("profile_available").value = String(p.available_now);
  document.getElementById("profile_desc").value = p.description || "";
  document.getElementById("profile_video").value = p.video_url || "";
}

async function saveProfile(){
  const payload = {
    user_id: Number(document.getElementById("user_id").value),
    profile_type: document.getElementById("profile_type").value,
    description: document.getElementById("profile_desc").value.trim() || null,
    video_url: document.getElementById("profile_video").value.trim() || null,
    available_now: document.getElementById("profile_available").value === "true"
  };

  const res = await fetch("/api/v1/profiles", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  const out = document.getElementById("profile_result");
  out.style.display = "block";
  out.textContent = await res.text();

  await fetchProfiles(); // refresca selector
}

async function createOffer(){
  const profileId = Number(document.getElementById("offer_profile_id").value);
  if (!profileId){
    alert("Selecciona o crea un perfil primero.");
    return;
  }

  const payload = {
    profile_id: profileId,
    offer_kind: document.getElementById("offer_kind").value,
    category: document.getElementById("offer_category").value.trim(),
    title: document.getElementById("offer_title").value.trim(),
    description: document.getElementById("offer_desc").value.trim() || null,
    price: document.getElementById("offer_price").value ? Number(document.getElementById("offer_price").value) : null,
    currency: document.getElementById("offer_currency").value.trim() || "EUR",
    available_now: document.getElementById("offer_available").value === "true",
    allergens: document.getElementById("offer_allergens").value.trim() || null
  };

  const res = await fetch("/api/v1/offers", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  const out = document.getElementById("offer_result");
  out.style.display = "block";
  out.textContent = await res.text();

  await loadMyOffers();
}

async function loadMyOffers(){
  const profileId = Number(document.getElementById("offer_profile_id").value);
  const list = document.getElementById("my_offers");
  list.innerHTML = "";

  if (!profileId){
    list.innerHTML = `<div class="muted">Selecciona un perfil para ver sus ofertas.</div>`;
    return;
  }

  const res = await fetch("/api/v1/offers?profile_id=" + profileId);
  const data = await res.json();

  if (data.length === 0){
    list.innerHTML = `<div class="muted">Aún no hay ofertas para este perfil.</div>`;
    return;
  }

  for (const o of data){
    const price = (o.price !== null && o.price !== undefined) ? `${o.price} ${o.currency}` : "—";
    const avail = o.available_now ? "✅ Disponible" : "⏸️ No disponible";
    list.innerHTML += `
      <div class="card-soft p-3">
        <div class="d-flex justify-content-between gap-3">
          <div>
            <div class="muted">${o.offer_kind} · ${o.category} · ${avail}</div>
            <div class="fw-bold fs-5">${o.title}</div>
            ${o.description ? `<div class="mt-2">${o.description}</div>` : ""}
            ${o.allergens ? `<div class="mt-2 small muted">Alérgenos: ${o.allergens}</div>` : ""}
          </div>
          <div class="text-end fw-bold">${price}</div>
        </div>
      </div>
    `;
  }
}

fetchProfiles();
</script>
{% endblock %}
