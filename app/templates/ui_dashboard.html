{% extends "base.html" %}
{% block content %}
<div class="row g-4">
  <div class="col-12">
    <div class="card-soft p-4">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
          <div class="badge badge-soft mb-2">Panel</div>
          <h2 class="fw-bold mb-1">Gestiona tu perfil y publica ofertas</h2>
          <div class="muted">Todo agrupado: perfil ‚Üí oferta ‚Üí listado.</div>
        </div>
        <a class="btn btn-outline-dark rounded-2xl" href="/docs">Abrir API</a>
      </div>
    </div>
  </div>

  <!-- PERFIL -->
  <div class="col-lg-6">
    <div class="card-soft p-4 h-100">
      <h4 class="fw-bold mb-3">1) Tu perfil</h4>

      <label class="form-label">Selecciona un perfil (no escribir IDs)</label>
      <div class="d-flex gap-2">
        <select id="profile_select" class="form-select"></select>
        <button class="btn btn-outline-dark rounded-2xl" onclick="loadSelectedProfile()">Cargar</button>
      </div>
      <div class="form-text mb-3">Si no tienes ninguno, crea uno abajo.</div>

      <div class="row g-2">
        <div class="col-12">
          <label class="form-label">User ID</label>
          <input id="user_id" class="form-control" placeholder="Ej. 1">
          <div class="form-text">De momento lo ponemos manual. Luego lo haremos con login.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Tipo</label>
          <select id="profile_type" class="form-select">
            <option value="COMUNITARIO">Comunitario</option>
            <option value="PRO">Profesional</option>
            <option value="AMBOS">Ambos</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Disponible ahora</label>
          <select id="profile_available" class="form-select">
            <option value="true">S√≠</option>
            <option value="false" selected>No</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Descripci√≥n</label>
          <textarea id="profile_desc" class="form-control" rows="3"
            placeholder="Ej. Hago croquetas / Soy electricista..."></textarea>
        </div>

        <div class="col-12">
          <label class="form-label">Video URL (opcional)</label>
          <input id="profile_video" class="form-control" placeholder="https://...">
        </div>

        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-brand rounded-2xl px-4" onclick="saveProfile()">Guardar perfil</button>
        </div>

        <div class="col-12">
          <pre id="profile_result" class="mt-3 p-3 rounded-2xl bg-light border" style="display:none;"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- OFERTA -->
  <div class="col-lg-6">
    <div class="card-soft p-4 h-100">
      <h4 class="fw-bold mb-3">2) Publicar oferta</h4>

      <div class="row g-2">
        <div class="col-12">
          <label class="form-label">Perfil seleccionado</label>
          <input id="offer_profile_id" class="form-control" placeholder="Se rellena al seleccionar perfil" readonly>
        </div>

        <div class="col-md-6">
          <label class="form-label">Tipo</label>
          <select id="offer_kind" class="form-select">
            <option value="SERVICIO">Servicio (Profesional)</option>
            <option value="COMIDA">Comida (Comunitario)</option>
            <option value="AYUDA">Ayuda (Comunitario)</option>
            <option value="PRODUCTO">Producto (Comunitario)</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Disponible ahora</label>
          <select id="offer_available" class="form-select">
            <option value="true">S√≠</option>
            <option value="false" selected>No</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Categor√≠a</label>
          <input id="offer_category" class="form-control" placeholder="Electricidad / Comida casera">
        </div>

        <div class="col-md-6">
          <label class="form-label">T√≠tulo</label>
          <input id="offer_title" class="form-control" placeholder="Electricista urgente / Croquetas caseras hoy">
        </div>

        <div class="col-12">
          <label class="form-label">Descripci√≥n</label>
          <textarea id="offer_desc" class="form-control" rows="3"
            placeholder="Detalles, horario, zona, etc."></textarea>
        </div>

        <div class="col-md-4">
          <label class="form-label">Precio (opcional)</label>
          <input id="offer_price" type="number" step="0.01" class="form-control" placeholder="8.00">
        </div>

        <div class="col-md-2">
          <label class="form-label">Moneda</label>
          <input id="offer_currency" class="form-control" value="EUR">
        </div>

        <div class="col-md-6">
          <label class="form-label">Al√©rgenos (solo comida)</label>
          <input id="offer_allergens" class="form-control" placeholder="gluten, leche, huevo...">
        </div>

        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-brand rounded-2xl px-4" onclick="createOffer()">Publicar oferta</button>
          <button class="btn btn-outline-dark rounded-2xl" onclick="loadMyOffers()">Ver mis ofertas</button>
        </div>

        <div class="col-12">
          <pre id="offer_result" class="mt-3 p-3 rounded-2xl bg-light border" style="display:none;"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- LISTADO -->
  <div class="col-12">
    <div class="card-soft p-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="fw-bold mb-0">3) Mis ofertas</h4>
        <button class="btn btn-outline-dark rounded-2xl" onclick="loadMyOffers()">Actualizar</button>
      </div>
      <div id="my_offers" class="vstack gap-3"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let PROFILES = [];

  async function fetchProfiles() {
    const res = await fetch("/api/v1/profiles");
    PROFILES = await res.json();

    const sel = document.getElementById("profile_select");
    sel.innerHTML = "";

    if (PROFILES.length === 0) {
      sel.innerHTML = `<option value="">(No hay perfiles a√∫n)</option>`;
      return;
    }

    for (const p of PROFILES) {
      sel.innerHTML += `<option value="${p.id}">Perfil #${p.id} ¬∑ ${p.profile_type} ¬∑ user ${p.user_id}</option>`;
    }

    // autoselecciona el primero
    sel.value = PROFILES[0].id;
    loadSelectedProfile();
  }

  function loadSelectedProfile() {
    const id = Number(document.getElementById("profile_select").value);
    const p = PROFILES.find(x => x.id === id);
    if (!p) return;

    document.getElementById("offer_profile_id").value = p.id;
    document.getElementById("user_id").value = p.user_id;
    document.getElementById("profile_type").value = p.profile_type;
    document.getElementById("profile_available").value = String(p.available_now);
    document.getElementById("profile_desc").value = p.description || "";
    document.getElementById("profile_video").value = p.video_url || "";
  }

  async function saveProfile() {
    const payload = {
      user_id: Number(document.getElementById("user_id").value),
      profile_type: document.getElementById("profile_type").value,
      description: document.getElementById("profile_desc").value.trim() || null,
      video_url: document.getElementById("profile_video").value.trim() || null,
      available_now: document.getElementById("profile_available").value === "true"
    };

    const res = await fetch("/api/v1/profiles", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const out = document.getElementById("profile_result");
    out.style.display = "block";
    out.textContent = await res.text();

    await fetchProfiles(); // refresca selector
  }

  async function createOffer() {
    const profileId = Number(document.getElementById("offer_profile_id").value);
    if (!profileId) {
      alert("Selecciona o crea un perfil primero.");
      return;
    }

    const payload = {
      profile_id: profileId,
      offer_kind: document.getElementById("offer_kind").value,
      category: document.getElementById("offer_category").value.trim(),
      title: document.getElementById("offer_title").value.trim(),
      description: document.getElementById("offer_desc").value.trim() || null,
      price: document.getElementById("offer_price").value ? Number(document.getElementById("offer_price").value) : null,
      currency: document.getElementById("offer_currency").value.trim() || "EUR",
      available_now: document.getElementById("offer_available").value === "true",
      allergens: document.getElementById("offer_allergens").value.trim() || null
    };

    const res = await fetch("/api/v1/offers", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const out = document.getElementById("offer_result");
    out.style.display = "block";
    out.textContent = await res.text();

    await loadMyOffers();
  }

  async function loadMyOffers() {
    const profileId = Number(document.getElementById("offer_profile_id").value);
    const list = document.getElementById("my_offers");
    list.innerHTML = "";

    if (!profileId) {
      list.innerHTML = `<div class="muted">Selecciona un perfil para ver sus ofertas.</div>`;
      return;
    }

    const res = await fetch("/api/v1/offers?profile_id=" + profileId);
    const data = await res.json();

    if (data.length === 0) {
      list.innerHTML = `<div class="muted">A√∫n no hay ofertas para este perfil.</div>`;
      return;
    }

    for (const o of data) {
      const price = (o.price !== null && o.price !== undefined) ? `${o.price} ${o.currency}` : "‚Äî";
      const avail = o.available_now ? "‚úÖ Disponible" : "‚è∏Ô∏è No disponible";

      // Logic for link: Feed if video, Detail if not
      const hasVideo = !!o.video_path;
      const link = hasVideo
        ? `/ui/feed?cat=${encodeURIComponent(o.category)}&start_id=${o.id}`
        : `/ui/offer/${o.id}`;

      list.innerHTML += `
      <a href="${link}" class="text-decoration-none text-dark">
        <div class="card-soft p-3">
          <div class="d-flex justify-content-between gap-3">
            <div>
              <div class="muted">${o.offer_kind} ¬∑ ${o.category} ¬∑ ${avail}</div>
              <div class="fw-bold fs-5">${o.title}</div>
              ${o.description ? `<div class="mt-2">${o.description}</div>` : ""}
              ${o.allergens ? `<div class="mt-2 small muted">Al√©rgenos: ${o.allergens}</div>` : ""}
              <div class="d-flex gap-2 mt-2">
                 ${hasVideo ? '<div class="badge bg-dark">üìπ Video</div>' : ''}
                 <button class="btn btn-sm btn-outline-secondary z-3 position-relative" 
                   onclick="event.preventDefault(); editOffer(${o.id})">‚úèÔ∏è Editar</button>
              </div>
            </div>
            <div class="text-end fw-bold">${price}</div>
          </div>
        </div>
      </a>
    `;
    }
  }

  async function editOffer(id) {
    try {
      const res = await fetch(`/api/v1/offers?mine=true&profile_id=${document.getElementById("offer_profile_id").value}&limit=1000`);
      const offers = await res.json();
      const offer = offers.find(o => o.id === id);
      if (!offer) { alert("Error: no se encuentra la oferta"); return; }

      // Mapear al formato Draft
      const d = {
        editing_id: offer.id, // Flag vital
        category: offer.category,
        title: offer.title,
        description: offer.desc, // Cuidado con el mapeo, en API puede venir como desc o description? Check schema.
        price: offer.price,
        offer_type: (offer.category.includes("Mercado") || offer.category.includes("Inmobiliaria") || offer.category.includes("Veh√≠culos")) ? 'sales' : 'service',
        // Mapeo extra info ...
      };

      // API devuelve 'desc', pero en el draft usamos 'description'? 
      // En list_offers: "desc": o.description or ""
      // En createOffer payload usamos description.
      // Vamos a usar description.
      d.description = offer.desc;

      // Recuperar extra_info
      if (offer.extra) {
        Object.assign(d, offer.extra);
        // Mapeos espec√≠ficos si hacen falta
        if (offer.extra.zone_text) d.zone_text = offer.extra.zone_text;
        if (offer.extra.city) d.city = offer.extra.city;

        // Inmo
        if (offer.extra.rooms) d.rooms = offer.extra.rooms;
        if (offer.extra.sqm) d.sqm = offer.extra.sqm;
        // ... resto de campos se pueden asignar directo si coinciden los nombres
        // En w4 publish: rooms: d.rooms
        // En detail: info.rooms
        // Parece que coinciden mayormente.
        d.bathrooms = offer.extra.bathrooms;
        d.floor = offer.extra.floor;
        d.lift = offer.extra.lift;
        d.terrace = offer.extra.terrace;
        d.ac = offer.extra.ac;
        d.parking = offer.extra.parking;

        // Motor
        d.carBrand = offer.extra.car_brand; // ojo camelCase vs snake_case
        d.carModel = offer.extra.car_model;
        d.carYear = offer.extra.car_year;
        d.carKm = offer.extra.car_km;
        d.carCC = offer.extra.car_cc;
        d.carHp = offer.extra.car_hp;
        d.carFuel = offer.extra.car_fuel;
        d.carTrans = offer.extra.car_trans;
      }

      // Available now
      // en dashboard list: avail = o.available_now
      // API response: available_now
      d.available_now = (offer.status === "Disponible"); // Ojo, en visual dice status, en API es available_now...
      // Revisando web.py: "status": "Disponible" if o.available_now else "Consultar"
      d.available_now = (offer.status === "Disponible");

      // Profile ID para la key
      const pid = document.getElementById("offer_profile_id").value || "anon";
      localStorage.setItem("draft_offer_" + pid, JSON.stringify(d));

      // Redirigir
      location.href = `/ui/offers/new?type=${d.offer_type}`;

    } catch (e) {
      console.error(e);
      alert("Error preparando edici√≥n: " + e.message);
    }
  }
  fetchProfiles();
</script>
{% endblock %}